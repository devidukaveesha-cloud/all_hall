<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seller Center</title>
  <script type="module" src="app.js"></script>
</head>
<body>
  <h1>Seller Center</h1>

  <!-- Product Form -->
  <form id="product-form">
    <input type="text" id="prod-name" placeholder="Product Name" required><br>
    <input type="number" id="prod-price" placeholder="Price" required><br>
    <textarea id="prod-desc" placeholder="Description"></textarea><br>
    <input type="file" id="prod-img" accept="image/*" required><br>
    <button type="submit">Add Product</button>
  </form>

  <div id="message-box"></div>
  <hr>
  <h2>My Products</h2>
  <div id="product-list"></div>

  <script type="module">
    import { auth, db, storage } from "./app.js";
    import { collection, addDoc, query, where, getDocs } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
    import { onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const form = document.getElementById("product-form");
    const productList = document.getElementById("product-list");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadProducts();
      } else {
        window.location.href = "login.html"; // not logged in
      }
    });

    // Submit new product
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const name = document.getElementById("prod-name").value;
      const price = document.getElementById("prod-price").value;
      const desc = document.getElementById("prod-desc").value;
      const file = document.getElementById("prod-img").files[0];

      if (!file) {
        alert("Please select an image!");
        return;
      }

      try {
        // 1. upload image to storage
        const storageRef = ref(storage, "products/" + Date.now() + "_" + file.name);
        await uploadBytes(storageRef, file);
        const imageUrl = await getDownloadURL(storageRef);

        // 2. save product data to Firestore
        await addDoc(collection(db, "products"), {
          sellerId: currentUser.uid,
          name,
          price: parseFloat(price),
          desc,
          imageUrl,
          createdAt: new Date()
        });

        alert("Product added!");
        form.reset();
        loadProducts();
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Load seller's products
    async function loadProducts() {
      productList.innerHTML = "";
      const q = query(collection(db, "products"), where("sellerId", "==", currentUser.uid));
      const snap = await getDocs(q);
      snap.forEach((doc) => {
        const data = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `
          <h3>${data.name}</h3>
          <p>${data.desc}</p>
          <p>Price: ${data.price}</p>
          <img src="${data.imageUrl}" width="150">
        `;
        productList.appendChild(div);
      });
    }
  </script>
</body>
</html>
